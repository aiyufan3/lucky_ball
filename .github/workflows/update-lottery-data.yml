name: æ›´æ–°å½©ç¥¨æ•°æ®å’Œåˆ†ææŠ¥å‘Š

on:
  schedule:
    # æ¯å¤©æ™šä¸Š23:00 (UTC+8) è¿è¡Œï¼Œå¯¹åº” 15:00 UTC
    - cron: '0 15 * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘
  push:
    branches: [ main ]  # æ¨é€åˆ°mainåˆ†æ”¯æ—¶è§¦å‘
  pull_request:
    branches: [ main ]  # PRåˆå¹¶åˆ°mainåˆ†æ”¯æ—¶è§¦å‘
    types: [ closed ]   # åªåœ¨PRå…³é—­æ—¶è§¦å‘

permissions:
  contents: write

jobs:
  update-lottery-data:
    runs-on: ubuntu-latest
    # ç¡®ä¿PRåªåœ¨åˆå¹¶æ—¶è¿è¡Œï¼Œè€Œä¸æ˜¯ç®€å•å…³é—­æ—¶è¿è¡Œ
    if: github.event_name != 'pull_request' || github.event.pull_request.merged == true

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: ç¼“å­˜pipä¾èµ–
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install requests pandas numpy matplotlib seaborn beautifulsoup4 hjson DrissionPage

        # DrissionPage å¦‚éœ€æµè§ˆå™¨ï¼Œè¯·åœ¨éœ€è¦æ—¶å¼€å¯ä»¥ä¸‹è„šæœ¬ï¼ˆé»˜è®¤å…³é—­ä»¥åŠ å¿«æ‰§è¡Œé€Ÿåº¦ï¼‰
        # echo "å®‰è£…Chromeæµè§ˆå™¨..."
        # wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
        # echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" | sudo tee /etc/apt/sources.list.d/google-chrome.list
        # sudo apt-get update
        # sudo apt-get install -y google-chrome-stable
        # google-chrome --version
        # export DISPLAY=:99

    - name: è¿è¡Œå½©ç¥¨æ•°æ®åˆ†æ
      run: |
        echo "å¼€å§‹è¿è¡Œå½©ç¥¨æ•°æ®åˆ†æ..."
        if [ -f "main.py" ]; then
          python main.py || true
        elif [ -f "lottery_analyzer.py" ]; then
          python lottery_analyzer.py || true
        else
          echo "æœªæ‰¾åˆ° main.py æˆ– lottery_analyzer.pyï¼Œè·³è¿‡åˆ†ææ­¥éª¤"
        fi
        echo "åˆ†æå®Œæˆï¼Œç»§ç»­åˆ°æ–‡ä»¶å˜æ›´æ£€æŸ¥æ­¥éª¤..."

    - name: æ£€æŸ¥æ–‡ä»¶å˜æ›´
      id: git-check
      run: |
        echo "æ£€æŸ¥æ–‡ä»¶å˜æ›´..."
        # ä»…åœ¨è¿™äº›ç›®å½•/æ–‡ä»¶å­˜åœ¨æ—¶å†æ¯”è¾ƒ
        TARGETS=()
        for p in data reports pics; do
          [ -e "$p" ] && TARGETS+=("$p")
        done
        if [ ${#TARGETS[@]} -eq 0 ]; then
          echo "æœªæ‰¾åˆ° data/ reports/ pics/ ç›®å½•æˆ–æ–‡ä»¶ï¼Œè§†ä¸ºæ— å˜åŒ–"
          echo "changed=false" >> $GITHUB_OUTPUT
          exit 0
        fi

        CHANGED=false

        # 1) æ£€æµ‹æœªè·Ÿè¸ª(æ–°)æ–‡ä»¶
        UNTRACKED=$(git ls-files --others --exclude-standard -- "${TARGETS[@]}")
        if [ -n "$UNTRACKED" ]; then
          echo "å‘ç°æœªè·Ÿè¸ªæ–‡ä»¶:"
          echo "$UNTRACKED"
          CHANGED=true
        fi

        # 2) æ£€æµ‹å·²è·Ÿè¸ªæ–‡ä»¶çš„ä¿®æ”¹/åˆ é™¤
        if ! git diff --exit-code -- "${TARGETS[@]}" >/dev/null 2>&1; then
          echo "å‘ç°å·²è·Ÿè¸ªæ–‡ä»¶ä¿®æ”¹/åˆ é™¤"
          CHANGED=true
        fi

        if [ "$CHANGED" = true ]; then
          echo "changed=true" >> $GITHUB_OUTPUT
        else
          echo "æ²¡æœ‰æ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´"
          echo "changed=false" >> $GITHUB_OUTPUT
        fi

    - name: æäº¤æ›´æ–°
      if: steps.git-check.outputs.changed == 'true'
      run: |
        echo "å‡†å¤‡æäº¤æ–‡ä»¶å˜æ›´..."
        git config --local user.email "snjyor@gmail.com"
        git config --local user.name "snjyor"

        [ -e "data" ] && git add -A data || echo "data ç›®å½•ä¸å­˜åœ¨"
        [ -e "reports" ] && git add -A reports || echo "reports ç›®å½•ä¸å­˜åœ¨"
        [ -e "pics" ] && git add -A pics || echo "pics ç›®å½•ä¸å­˜åœ¨"

        if git diff --cached --quiet; then
          echo "æ²¡æœ‰æ–‡ä»¶éœ€è¦æäº¤"
          exit 0
        fi

        commit_message="ğŸ¯ æ›´æ–°å½©ç¥¨æ•°æ®å’Œåˆ†ææŠ¥å‘Š - $(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S') (UTC+8)"
        git commit -m "$commit_message"
        git push
        echo "æ–‡ä»¶æäº¤æˆåŠŸ"

    - name: åˆ›å»ºé‡å¤§æ›´æ–°çš„å‘å¸ƒç‰ˆæœ¬
      if: steps.git-check.outputs.changed == 'true'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "å‡†å¤‡åˆ›å»ºå‘å¸ƒç‰ˆæœ¬..."
        TAG_NAME="$(TZ='Asia/Shanghai' date +'%Y%m%d')"
        if ! git tag | grep -q "^$TAG_NAME$"; then
          git tag $TAG_NAME
          git push origin $TAG_NAME

          NOTES=$'## ğŸ¯ å½©ç¥¨æ•°æ®æ›´æ–° - '"$(TZ='Asia/Shanghai' date +'%Yå¹´%mæœˆ%dæ—¥')"$' (UTC+8)\n\n'
          NOTES+=$'### ğŸ“Š æœ¬æ¬¡æ›´æ–°å†…å®¹\n'
          NOTES+=$'- æŠ“å–æœ€æ–°åŒè‰²çƒå¼€å¥–æ•°æ®\n'
          NOTES+=$'- æ›´æ–°ç»Ÿè®¡åˆ†æå›¾è¡¨\n'
          NOTES+=$'- åˆ·æ–°å·ç é¢‘ç‡åˆ†æ\n'
          NOTES+=$'- æ›´æ–°åˆ†ææŠ¥å‘Šæ–‡æ¡£\n\n'
          NOTES+=$'### ğŸ“ æ›´æ–°æ–‡ä»¶\n'
          NOTES+=$'**åŒè‰²çƒæ•°æ®ï¼š**\n'
          NOTES+=$'- data/lottery_data.json - åŒè‰²çƒå¼€å¥–æ•°æ®\n'
          NOTES+=$'- data/lottery_aggregated_data.hjson - åŒè‰²çƒèšåˆåˆ†ææ•°æ®\n'
          NOTES+=$'- reports/double_color_ball_analysis_report.md - åŒè‰²çƒåˆ†ææŠ¥å‘Š\n'
          NOTES+=$'- pics/lottery_frequency_analysis.png - åŒè‰²çƒé¢‘ç‡å›¾è¡¨\n\n'
          NOTES+=$'ï¼ˆå¤‡æ³¨ï¼šå¤§ä¹é€æ•°æ®å·²æš‚åœå¤„ç†ï¼‰\n\n'
          NOTES+=$'### âš ï¸ å…è´£å£°æ˜\n'
          NOTES+=$'æœ¬æ•°æ®ä»…ä¾›å­¦ä¹ å’Œç»Ÿè®¡åˆ†æä½¿ç”¨ï¼Œå½©ç¥¨å¼€å¥–å®Œå…¨éšæœºï¼Œè¯·ç†æ€§è´­å½©ã€‚\n'

          upload_files=""
          [ -f "data/lottery_data.json" ] && upload_files="$upload_files data/lottery_data.json"
          [ -f "data/lottery_aggregated_data.hjson" ] && upload_files="$upload_files data/lottery_aggregated_data.hjson"
          [ -f "reports/analysis_report.md" ] && upload_files="$upload_files reports/analysis_report.md"
          [ -f "pics/lottery_frequency_analysis.png" ] && upload_files="$upload_files pics/lottery_frequency_analysis.png"

          if [ -n "$upload_files" ]; then
            gh release create $TAG_NAME \
              --title "å½©ç¥¨æ•°æ®æ›´æ–° $TAG_NAME" \
              --notes "$NOTES" \
              $upload_files
            echo "å‘å¸ƒç‰ˆæœ¬åˆ›å»ºæˆåŠŸï¼ŒåŒ…å«æ–‡ä»¶: $upload_files"
          else
            gh release create $TAG_NAME \
              --title "å½©ç¥¨æ•°æ®æ›´æ–° $TAG_NAME" \
              --notes "$NOTES"
            echo "å‘å¸ƒç‰ˆæœ¬åˆ›å»ºæˆåŠŸï¼Œä½†æ²¡æœ‰æ•°æ®æ–‡ä»¶å¯ä¸Šä¼ "
          fi
        else
          echo "Tag $TAG_NAME å·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»ºå‘å¸ƒç‰ˆæœ¬"
        fi

    - name: è¾“å‡ºç»“æœ
      run: |
        if [ "${{ steps.git-check.outputs.changed }}" == "true" ]; then
          echo "âœ… å½©ç¥¨æ•°æ®å·²æ›´æ–°å¹¶æäº¤ - $(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S') (UTC+8)"
          echo "ğŸ“ æ›´æ–°çš„æ–‡ä»¶:"
          [ -f "data/lottery_data.json" ] && echo "  âœ“ åŒè‰²çƒå¼€å¥–æ•°æ®"
          [ -f "reports/analysis_report.md" ] && echo "  âœ“ åŒè‰²çƒåˆ†ææŠ¥å‘Š"
          [ -f "pics/lottery_frequency_analysis.png" ] && echo "  âœ“ åŒè‰²çƒé¢‘ç‡å›¾è¡¨"
        else
          echo "â„¹ï¸ å½©ç¥¨æ•°æ®æ— å˜åŒ–ï¼Œè·³è¿‡æäº¤ - $(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S') (UTC+8)"
        fi