name: æ›´æ–°å½©ç¥¨æ•°æ®å’Œåˆ†ææŠ¥å‘Š

on:
  schedule:
    # æ¯å¤©æ™šä¸Š23:00 (UTC+8) è¿è¡Œï¼Œå¯¹åº” 15:00 UTC
    - cron: '0 15 * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘
  push:
    branches: [ main ]  # æ¨é€åˆ°mainåˆ†æ”¯æ—¶è§¦å‘
  pull_request:
    branches: [ main ]  # PRåˆå¹¶åˆ°mainåˆ†æ”¯æ—¶è§¦å‘
    types: [ closed ]   # åªåœ¨PRå…³é—­æ—¶è§¦å‘

permissions:
  contents: write

jobs:
  update-lottery-data:
    runs-on: ubuntu-latest
    env:
      HEARTBEAT: "true"   # è‹¥å¸Œæœ›ä»…åœ¨çœŸå®æ•°æ®å˜åŒ–æ—¶æäº¤ï¼Œå°†å…¶æ”¹ä¸º "false"
      # ç½‘ç»œé‡è¯•é…ç½®
      MAX_RETRIES: 5
      RETRY_DELAY: 10
      NETWORK_TIMEOUT: 60
      # Gité…ç½®
      GIT_AUTHOR_NAME: "github-actions[bot]"
      GIT_AUTHOR_EMAIL: "github-actions[bot]@users.noreply.github.com"
      GIT_COMMITTER_NAME: "github-actions[bot]"
      GIT_COMMITTER_EMAIL: "github-actions[bot]@users.noreply.github.com"
    # ç¡®ä¿PRåªåœ¨åˆå¹¶æ—¶è¿è¡Œï¼Œè€Œä¸æ˜¯ç®€å•å…³é—­æ—¶è¿è¡Œ
    if: github.event_name != 'pull_request' || github.event.pull_request.merged == true

    steps:
    - name: ç½‘ç»œè¿æ¥æ£€æµ‹
      id: network_check
      run: |
        echo "ğŸ” æ£€æµ‹ç½‘ç»œè¿æ¥çŠ¶æ€..."
        
        # æµ‹è¯•åŸºæœ¬ç½‘ç»œè¿æ¥
        if ping -c 3 8.8.8.8 >/dev/null 2>&1; then
          echo "âœ… åŸºæœ¬ç½‘ç»œè¿æ¥æ­£å¸¸"
          echo "network_status=ok" >> $GITHUB_OUTPUT
        else
          echo "âŒ åŸºæœ¬ç½‘ç»œè¿æ¥å¤±è´¥"
          echo "network_status=failed" >> $GITHUB_OUTPUT
        fi
        
        # æµ‹è¯•DNSè§£æ
        if nslookup www.cwl.gov.cn >/dev/null 2>&1; then
          echo "âœ… DNSè§£ææ­£å¸¸"
          echo "dns_status=ok" >> $GITHUB_OUTPUT
        else
          echo "âŒ DNSè§£æå¤±è´¥"
          echo "dns_status=failed" >> $GITHUB_OUTPUT
        fi
        
        # æµ‹è¯•APIå¯è¾¾æ€§
        if curl -s --connect-timeout 10 --max-time 30 "https://www.cwl.gov.cn" >/dev/null 2>&1; then
          echo "âœ… å½©ç¥¨å®˜ç½‘å¯è¾¾"
          echo "api_status=ok" >> $GITHUB_OUTPUT
        else
          echo "âŒ å½©ç¥¨å®˜ç½‘ä¸å¯è¾¾"
          echo "api_status=failed" >> $GITHUB_OUTPUT
        fi

    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        # ç¡®ä¿æ£€å‡ºæ·±åº¦è¶³å¤Ÿï¼Œé¿å…æµ…å…‹éš†é—®é¢˜
        fetch-depth: 0

    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: ç¼“å­˜pipä¾èµ–
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: å®‰è£…ä¾èµ–
      run: |
        echo "ğŸ“¦ å®‰è£…Pythonä¾èµ–åŒ…..."
        
        # å‡çº§pip
        python -m pip install --upgrade pip
        
        # å®‰è£…æ ¸å¿ƒä¾èµ–ï¼ˆå¸¦é‡è¯•æœºåˆ¶ï¼‰
        for i in {1..${{ env.MAX_RETRIES }}}; do
          echo "å°è¯•å®‰è£…ä¾èµ– (ç¬¬ $i æ¬¡)..."
          if pip install requests pandas numpy matplotlib seaborn beautifulsoup4 hjson DrissionPage scipy statsmodels; then
            echo "âœ… æ ¸å¿ƒä¾èµ–å®‰è£…æˆåŠŸ"
            break
          else
            echo "âŒ ç¬¬ $i æ¬¡å®‰è£…å¤±è´¥"
            if [ $i -lt ${{ env.MAX_RETRIES }} ]; then
              echo "ç­‰å¾… ${{ env.RETRY_DELAY }} ç§’åé‡è¯•..."
              sleep ${{ env.RETRY_DELAY }}
            else
              echo "âŒ æ‰€æœ‰é‡è¯•éƒ½å¤±è´¥ï¼Œé€€å‡º"
              exit 1
            fi
          fi
        done

        # å®‰è£… CPU ç‰ˆ PyTorchï¼ˆé¿å… CUDA ä¾èµ–ï¼Œå¸¦é‡è¯•ï¼‰
        echo "ğŸ§  å®‰è£…PyTorch CPUç‰ˆæœ¬..."
        for i in {1..3}; do
          if pip install torch --index-url https://download.pytorch.org/whl/cpu; then
            echo "âœ… PyTorchå®‰è£…æˆåŠŸ"
            break
          else
            echo "âŒ PyTorchå®‰è£…å¤±è´¥ (ç¬¬ $i æ¬¡)"
            if [ $i -lt 3 ]; then
              sleep 10
            fi
          fi
        done

        echo "âœ… æ‰€æœ‰ä¾èµ–å®‰è£…å®Œæˆ"

    - name: ç½‘ç»œçŠ¶æ€éªŒè¯
      if: steps.network_check.outputs.network_status == 'failed' || steps.network_check.outputs.api_status == 'failed'
      run: |
        echo "âš ï¸ ç½‘ç»œçŠ¶æ€å¼‚å¸¸ï¼Œå°è¯•ç½‘ç»œä¿®å¤..."
        
        # å°è¯•åˆ·æ–°DNSç¼“å­˜
        if command -v systemd-resolve >/dev/null 2>&1; then
          sudo systemd-resolve --flush-caches || true
        fi
        
        # ç­‰å¾…ç½‘ç»œæ¢å¤
        echo "ç­‰å¾…ç½‘ç»œæ¢å¤..."
        sleep 30
        
        # é‡æ–°æµ‹è¯•ç½‘ç»œ
        if ping -c 3 8.8.8.8 >/dev/null 2>&1; then
          echo "âœ… ç½‘ç»œå·²æ¢å¤"
        else
          echo "âŒ ç½‘ç»œä»æœªæ¢å¤ï¼Œä½†ç»§ç»­æ‰§è¡Œ..."
        fi

    - name: è¿è¡Œæ•°æ®æŠ“å–ä¸åˆ†æ (åŒè‰²çƒ + å¿«ä¹8)
      run: |
        echo "ğŸš€ å¼€å§‹è¿è¡Œæ•°æ®åˆ†æ..."
        export MPLBACKEND=Agg
        mkdir -p data reports pics
        exit_code=0
        
        # è®¾ç½®ç¯å¢ƒå˜é‡
        export PYTHONUNBUFFERED=1
        export PYTHONIOENCODING=utf-8
        
        # ç½‘ç»œé‡è¯•å‡½æ•°
        retry_with_backoff() {
          local max_attempts=${{ env.MAX_RETRIES }}
          local delay=${{ env.RETRY_DELAY }}
          local attempt=1
          
          while [ $attempt -le $max_attempts ]; do
            echo "ğŸ”„ å°è¯•æ‰§è¡Œ $1 (ç¬¬ $attempt æ¬¡)..."
            
            if eval "$1"; then
              echo "âœ… $1 æ‰§è¡ŒæˆåŠŸ"
              return 0
            else
              echo "âŒ $1 æ‰§è¡Œå¤±è´¥ (ç¬¬ $attempt æ¬¡)"
              
              if [ $attempt -lt $max_attempts ]; then
                echo "â³ ç­‰å¾… ${delay} ç§’åé‡è¯•..."
                sleep $delay
                delay=$((delay * 2))  # æŒ‡æ•°é€€é¿
              fi
              
              attempt=$((attempt + 1))
            fi
          done
          
          echo "âŒ $1 åœ¨ $max_attempts æ¬¡å°è¯•åä»ç„¶å¤±è´¥"
          return 1
        }

        # è¿è¡ŒåŒè‰²çƒåˆ†æï¼ˆå¸¦é‡è¯•ï¼‰
        if [ -f "main.py" ]; then
          echo "[SSQ] è¿è¡Œ main.py ..."
          retry_with_backoff "python main.py" || exit_code=$?
        elif [ -f "scripts/lottery_analyzer.py" ]; then
          echo "[SSQ] è¿è¡Œ scripts/lottery_analyzer.py ..."
          retry_with_backoff "python scripts/lottery_analyzer.py" || exit_code=$?
        elif [ -f "lottery_analyzer.py" ]; then
          echo "[SSQ] è¿è¡Œ lottery_analyzer.py ..."
          retry_with_backoff "python lottery_analyzer.py" || exit_code=$?
        else
          echo "[SSQ] æœªæ‰¾åˆ°å…¥å£ (main.py æˆ– lottery_analyzer.py)ï¼Œè·³è¿‡"
        fi

        # è¿è¡Œå¿«ä¹8åˆ†æï¼ˆå¸¦é‡è¯•ï¼‰
        if [ -f "scripts/super_eight.py" ]; then
          echo "[KL8] è¿è¡Œ scripts/super_eight.py ..."
          retry_with_backoff "python scripts/super_eight.py --fetch --limit 200 --recommend 5 --plots --plots_dual --report --plan --budget 22 --price_per_bet 2 --seed 42" || exit_code=$?
        elif [ -f "super_eight.py" ]; then
          echo "[KL8] è¿è¡Œ super_eight.py ..."
          retry_with_backoff "python super_eight.py --fetch --limit 200 --recommend 5 --plots --plots_dual --report --plan --budget 22 --price_per_bet 2 --seed 42" || exit_code=$?
        else
          echo "[KL8] æœªæ‰¾åˆ° super_eight.pyï¼Œè·³è¿‡"
        fi

        echo "ğŸ“Š åˆ†æå®Œæˆï¼Œé€€å‡ºç : $exit_code"
        
        # å³ä½¿æœ‰é”™è¯¯ä¹Ÿç»§ç»­æ‰§è¡Œï¼Œé¿å…æ•´ä¸ªå·¥ä½œæµå¤±è´¥
        if [ $exit_code -ne 0 ]; then
          echo "âš ï¸ éƒ¨åˆ†åˆ†æå¤±è´¥ï¼Œä½†ç»§ç»­æ‰§è¡Œåç»­æ­¥éª¤..."
        fi

        if [ "$HEARTBEAT" = "true" ]; then
          mkdir -p .github
          date -u +"%Y-%m-%dT%H:%M:%SZ" > .github/.last_run_utc.txt
          echo "å·²å†™å…¥å¿ƒè·³æ–‡ä»¶ .github/.last_run_utc.txt"
        fi

        echo "ç»§ç»­åˆ°æ–‡ä»¶å˜æ›´æ£€æŸ¥æ­¥éª¤..."

    - name: æ£€æŸ¥æ–‡ä»¶å˜æ›´
      id: check_changes
      run: |
        echo "ğŸ” æ£€æŸ¥æ–‡ä»¶å˜æ›´..."
        # ä»…åœ¨è¿™äº›ç›®å½•/æ–‡ä»¶å­˜åœ¨æ—¶å†æ¯”è¾ƒ
        TARGETS=()
        for p in data reports pics; do
          [ -e "$p" ] && TARGETS+=("$p")
        done
        [ -f ".github/.last_run_utc.txt" ] && TARGETS+=(".github/.last_run_utc.txt")
        [ -f "data/kl8_history.json" ] && TARGETS+=("data/kl8_history.json")
        [ -f "reports/kl8_analysis_report.md" ] && TARGETS+=("reports/kl8_analysis_report.md")
        [ -f "reports/kl8_profit_plan.md" ] && TARGETS+=("reports/kl8_profit_plan.md")
        [ -f "pics/kl8_frequency_hist.png" ] && TARGETS+=("pics/kl8_frequency_hist.png")
        [ -f "pics/kl8_ema_heatmap.png" ] && TARGETS+=("pics/kl8_ema_heatmap.png")
        [ -f "pics/kl8_overlap_compare.png" ] && TARGETS+=("pics/kl8_overlap_compare.png")
        [ -f "pics/kl8_dual_frequency_style.png" ] && TARGETS+=("pics/kl8_dual_frequency_style.png")
        [ -f "reports/colorballs_analysis_report.md" ] && TARGETS+=("reports/colorballs_analysis_report.md")
        [ -f "pics/lottery_frequency_analysis.png" ] && TARGETS+=("pics/lottery_frequency_analysis.png")
        if [ ${#TARGETS[@]} -eq 0 ]; then
          echo "æœªæ‰¾åˆ° data/ reports/ pics/ ç›®å½•æˆ–æ–‡ä»¶ï¼Œè§†ä¸ºæ— å˜åŒ–"
          echo "changed=false" >> $GITHUB_OUTPUT
          exit 0
        fi

        CHANGED=false

        # 1) æ£€æµ‹æœªè·Ÿè¸ª(æ–°)æ–‡ä»¶
        # ä¸ä½¿ç”¨ --exclude-standardï¼Œä¿è¯å³ä½¿è¢« .gitignore å¿½ç•¥çš„æ–‡ä»¶ä¹Ÿèƒ½è¢«æ£€æµ‹åˆ°
        UNTRACKED=$(git ls-files --others -- "${TARGETS[@]}")
        if [ -n "$UNTRACKED" ]; then
          echo "å‘ç°æœªè·Ÿè¸ªæ–‡ä»¶:"
          echo "$UNTRACKED"
          CHANGED=true
        fi

        # 2) æ£€æµ‹å·²è·Ÿè¸ªæ–‡ä»¶çš„ä¿®æ”¹/åˆ é™¤
        if ! git diff --exit-code -- "${TARGETS[@]}" >/dev/null 2>&1; then
          echo "å‘ç°å·²è·Ÿè¸ªæ–‡ä»¶ä¿®æ”¹/åˆ é™¤"
          CHANGED=true
        fi

        if [ "$CHANGED" = true ]; then
          echo "changed=true" >> $GITHUB_OUTPUT
        else
          echo "changed=false" >> $GITHUB_OUTPUT
        fi

    - name: æäº¤æ›´æ–°
      if: steps.check_changes.outputs.changed == 'true'
      run: |
        echo "ğŸ“ å‡†å¤‡æäº¤æ–‡ä»¶å˜æ›´..."
        
        # é…ç½®Gitç”¨æˆ·èº«ä»½ï¼ˆGitHub Actionsï¼‰
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        
        echo "ä½¿ç”¨Gité…ç½®: $(git config user.name) <$(git config user.email)>"
        
        # æ˜¾ç¤ºå½“å‰GitçŠ¶æ€
        echo "ğŸ” å½“å‰GitçŠ¶æ€:"
        git status --porcelain || echo "æ— æ³•è·å–GitçŠ¶æ€"
        
        # æ·»åŠ æ–‡ä»¶åˆ°æš‚å­˜åŒº
        [ -e "data" ] && git add -A data || echo "data ç›®å½•ä¸å­˜åœ¨"
        [ -e "reports" ] && git add -A reports || echo "reports ç›®å½•ä¸å­˜åœ¨"
        [ -e "pics" ] && git add -A pics || echo "pics ç›®å½•ä¸å­˜åœ¨"

        # å¼ºåˆ¶æ·»åŠ è¢« .gitignore å¿½ç•¥ä½†éœ€è¦æäº¤çš„è‡ªåŠ¨ç”Ÿæˆç‰©
        [ -f "data/lottery_data.json" ] && git add -f data/lottery_data.json || true
        [ -f "data/kl8_history.json" ] && git add -f data/kl8_history.json || true
        [ -f "data/lottery_aggregated_data.hjson" ] && git add -f data/lottery_aggregated_data.hjson || true
        # reports ä¸‹çš„ Markdownï¼ˆå­˜åœ¨æ—¶å†æ·»åŠ ï¼Œé¿å… glob å±•å¼€å¤±è´¥ï¼‰
        ls reports/*.md >/dev/null 2>&1 && git add -f reports/*.md || true
        # éœ€è¦å‘å¸ƒåˆ°ä»“åº“çš„å›¾ç‰‡ï¼ˆå­˜åœ¨æ—¶å†æ·»åŠ ï¼‰
        [ -f "pics/lottery_frequency_analysis.png" ] && git add -f pics/lottery_frequency_analysis.png || true
        [ -f "pics/kl8_frequency_hist.png" ] && git add -f pics/kl8_frequency_hist.png || true
        [ -f "pics/kl8_ema_heatmap.png" ] && git add -f pics/kl8_ema_heatmap.png || true
        [ -f "pics/kl8_overlap_compare.png" ] && git add -f pics/kl8_overlap_compare.png || true
        [ -f "pics/kl8_dual_frequency_style.png" ] && git add -f pics/kl8_dual_frequency_style.png || true
        [ -f ".github/.last_run_utc.txt" ] && git add .github/.last_run_utc.txt

        # æ˜¾ç¤ºæš‚å­˜åŒºçŠ¶æ€
        echo "ğŸ“‹ æš‚å­˜åŒºçŠ¶æ€:"
        git diff --cached --name-only || echo "æ— æ³•è·å–æš‚å­˜åŒºçŠ¶æ€"

        if git diff --cached --quiet; then
          echo "æ²¡æœ‰æ–‡ä»¶éœ€è¦æäº¤"
          exit 0
        fi

        commit_message="Update lottery data and analysis reports - $(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S') (UTC+8)"
        echo "ğŸ’¾ æäº¤ä¿¡æ¯: $commit_message"
        
        # æäº¤ä»£ç 
        if git commit -m "$commit_message"; then
          echo "âœ… ä»£ç æäº¤æˆåŠŸ"
        else
          echo "âŒ ä»£ç æäº¤å¤±è´¥"
          exit 1
        fi
        
        # æ¨é€æ—¶ä¹Ÿä½¿ç”¨é‡è¯•æœºåˆ¶
        for i in {1..3}; do
          echo "ğŸš€ å°è¯•æ¨é€ä»£ç  (ç¬¬ $i æ¬¡)..."
          if git push; then
            echo "âœ… ä»£ç æ¨é€æˆåŠŸ"
            break
          else
            echo "âŒ æ¨é€å¤±è´¥ (ç¬¬ $i æ¬¡)"
            if [ $i -lt 3 ]; then
              echo "â³ ç­‰å¾… 10 ç§’åé‡è¯•..."
              sleep 10
            else
              echo "âŒ æ¨é€å¤±è´¥ï¼Œä½†ç»§ç»­æ‰§è¡Œåç»­æ­¥éª¤"
            fi
          fi
        done
        
        echo "ğŸ‰ æ–‡ä»¶æäº¤å’Œæ¨é€æµç¨‹å®Œæˆ"

    - name: åˆ›å»ºé‡å¤§æ›´æ–°çš„å‘å¸ƒç‰ˆæœ¬
      if: steps.check_changes.outputs.changed == 'true'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "ğŸ·ï¸ å‡†å¤‡åˆ›å»ºå‘å¸ƒç‰ˆæœ¬..."
        TAG_NAME="$(TZ='Asia/Shanghai' date +'%Y%m%d')"

        # å…ˆåŒæ­¥è¿œç«¯ tagsï¼Œé¿å…é‡å¤æ¨é€æ—¶æŠ¥é”™
        git fetch --tags --quiet || true

        if git ls-remote --tags origin | grep -q "refs/tags/$TAG_NAME$"; then
          echo "Tag $TAG_NAME å·²å­˜åœ¨äºè¿œç«¯ï¼Œè·³è¿‡åˆ›å»ºå‘å¸ƒç‰ˆæœ¬"
          exit 0
        fi

        git tag -f $TAG_NAME
        git push -f origin $TAG_NAME

        NOTES=$'## ğŸ¯ å½©ç¥¨æ•°æ®æ›´æ–° - '"$(TZ='Asia/Shanghai' date +'%Yå¹´%mæœˆ%dæ—¥')"$' (UTC+8)\n\n'
        NOTES+=$'### ğŸ“Š æœ¬æ¬¡æ›´æ–°å†…å®¹\n'
        NOTES+=$'- æŠ“å–æœ€æ–°å¼€å¥–æ•°æ®ï¼ˆåŒè‰²çƒ/å¿«ä¹8ï¼‰\n'
        NOTES+=$'- æ›´æ–°ç»Ÿè®¡åˆ†æå›¾è¡¨\n'
        NOTES+=$'- åˆ·æ–°å·ç é¢‘ç‡ä¸æŠ¥å‘Š\n\n'
        NOTES+=$'### ğŸ“ æ›´æ–°æ–‡ä»¶\n'
        NOTES+=$'**åŒè‰²çƒæ•°æ®ï¼š**\n'
        NOTES+=$'- data/lottery_data.json - åŒè‰²çƒå¼€å¥–æ•°æ®\n'
        NOTES+=$'- data/lottery_aggregated_data.hjson - åŒè‰²çƒèšåˆåˆ†ææ•°æ®\n'
        NOTES+=$'- pics/lottery_frequency_analysis.png - åŒè‰²çƒé¢‘ç‡å›¾è¡¨\n\n'
        NOTES+=$'**å¿«ä¹8æ•°æ®ï¼š**\n'
        NOTES+=$'- data/kl8_history.json - å¿«ä¹8å¼€å¥–æ•°æ®\n'
        NOTES+=$'- reports/kl8_analysis_report.md - å¿«ä¹8åˆ†ææŠ¥å‘Š\n'
        NOTES+=$'- pics/kl8_frequency_hist.png, pics/kl8_ema_heatmap.png, pics/kl8_overlap_compare.png, pics/kl8_dual_frequency_style.png\n\n'
        NOTES+=$'### âš ï¸ å…è´£å£°æ˜\n'
        NOTES+=$'æœ¬æ•°æ®ä»…ä¾›å­¦ä¹ å’Œç»Ÿè®¡åˆ†æä½¿ç”¨ï¼Œå½©ç¥¨å¼€å¥–å®Œå…¨éšæœºï¼Œè¯·ç†æ€§è´­å½©ã€‚\n'

        upload_files=""
        [ -f "data/lottery_data.json" ] && upload_files="$upload_files data/lottery_data.json"
        [ -f "data/lottery_aggregated_data.hjson" ] && upload_files="$upload_files data/lottery_aggregated_data.hjson"
        # SSQ reports (support both names)
        [ -f "reports/colorballs_analysis_report.md" ] && upload_files="$upload_files reports/colorballs_analysis_report.md"
        [ -f "pics/lottery_frequency_analysis.png" ] && upload_files="$upload_files pics/lottery_frequency_analysis.png"

        # KL8 artifacts
        [ -f "data/kl8_history.json" ] && upload_files="$upload_files data/kl8_history.json"
        [ -f "reports/kl8_analysis_report.md" ] && upload_files="$upload_files reports/kl8_analysis_report.md"
        [ -f "pics/kl8_frequency_hist.png" ] && upload_files="$upload_files pics/kl8_frequency_hist.png"
        [ -f "pics/kl8_ema_heatmap.png" ] && upload_files="$upload_files pics/kl8_ema_heatmap.png"
        [ -f "pics/kl8_overlap_compare.png" ] && upload_files="$upload_files pics/kl8_overlap_compare.png"
        [ -f "pics/kl8_dual_frequency_style.png" ] && upload_files="$upload_files pics/kl8_dual_frequency_style.png"

        if command -v gh >/dev/null 2>&1; then
          if [ -n "$upload_files" ]; then
            gh release create $TAG_NAME \
              --title "å½©ç¥¨æ•°æ®æ›´æ–° $TAG_NAME" \
              --notes "$NOTES" \
              $upload_files
            echo "å‘å¸ƒç‰ˆæœ¬åˆ›å»ºæˆåŠŸï¼ŒåŒ…å«æ–‡ä»¶: $upload_files"
          else
            gh release create $TAG_NAME \
              --title "å½©ç¥¨æ•°æ®æ›´æ–° $TAG_NAME" \
              --notes "$NOTES"
            echo "å‘å¸ƒç‰ˆæœ¬åˆ›å»ºæˆåŠŸï¼Œä½†æ²¡æœ‰æ•°æ®æ–‡ä»¶å¯ä¸Šä¼ "
          fi
        else
          echo "âš ï¸ æœªå®‰è£… gh CLIï¼Œè·³è¿‡åˆ›å»ºå‘å¸ƒç‰ˆæœ¬ã€‚"
        fi

    - name: è¾“å‡ºç»“æœ
      run: |
        echo "ğŸ¯ å·¥ä½œæµæ‰§è¡Œç»“æœæ€»ç»“"
        echo "================================"
        
        if [ "${{ steps.check_changes.outputs.changed }}" == "true" ]; then
          echo "âœ… å½©ç¥¨æ•°æ®å·²æ›´æ–°å¹¶æäº¤ - $(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S') (UTC+8)"
          echo "ğŸ“ æ›´æ–°çš„æ–‡ä»¶:"
          [ -f "data/lottery_data.json" ] && echo "  âœ“ åŒè‰²çƒå¼€å¥–æ•°æ®"
          [ -f "reports/colorballs_analysis_report.md" ] && echo "  âœ“ åŒè‰²çƒåˆ†ææŠ¥å‘Š (colorballs_analysis_report.md)"
          [ -f "pics/lottery_frequency_analysis.png" ] && echo "  âœ“ åŒè‰²çƒé¢‘ç‡å›¾è¡¨ (lottery_frequency_analysis.png)"
          [ -f ".github/.last_run_utc.txt" ] && echo "  âœ“ å¿ƒè·³æ–‡ä»¶ (.github/.last_run_utc.txt)"
          
          # æ˜¾ç¤ºGitæäº¤ä¿¡æ¯
          echo ""
          echo "ğŸ“ æœ€è¿‘çš„Gitæäº¤:"
          git log --oneline -3 || echo "æ— æ³•è·å–Gitæäº¤å†å²"
        else
          echo "â„¹ï¸ å½©ç¥¨æ•°æ®æ— å˜åŒ–ï¼Œè·³è¿‡æäº¤ - $(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S') (UTC+8)"
        fi
        
        echo ""
        echo "ğŸŒ ç½‘ç»œçŠ¶æ€æ€»ç»“:"
        echo "  ç½‘ç»œè¿æ¥: ${{ steps.network_check.outputs.network_status }}"
        echo "  DNSè§£æ: ${{ steps.network_check.outputs.dns_status }}"
        echo "  APIå¯è¾¾: ${{ steps.network_check.outputs.api_status }}"
        
        echo ""
        echo "ğŸ¤– æ‰§è¡Œç”¨æˆ·: github-actions[bot]"
        echo "â° æ‰§è¡Œæ—¶é—´: $(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S') (UTC+8)"
        echo "================================"