name: æ›´æ–°åŒè‰²çƒä¸å¿«ä¹8æ•°æ®ä¸æŠ¥å‘Š

on:
  schedule:
    # æ¯å¤©æ™šä¸Š23:00 (UTC+8) è¿è¡Œï¼Œå¯¹åº” 15:00 UTC
    - cron: '0 15 * * *'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
    types: [ closed ]

permissions:
  contents: write  # å…è®¸æ¨é€ä¸åˆ›å»º release

jobs:
  update-lottery-data:
    runs-on: ubuntu-latest
    if: github.event_name != 'pull_request' || github.event.pull_request.merged == true

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: ç¼“å­˜ pip ä¾èµ–
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            # å…œåº•å®‰è£…å¸¸ç”¨ä¾èµ–
            pip install requests pandas numpy matplotlib seaborn beautifulsoup4 hjson
          fi
          echo "MPLBACKEND=Agg" >> $GITHUB_ENV  # æ— å¤´ç¯å¢ƒä½¿ç”¨éäº¤äº’åç«¯

      - name: è¿è¡Œ åŒè‰²çƒï¼ˆDoubleColorBallï¼‰åˆ†æ
        run: |
          echo "å¼€å§‹è¿è¡Œï¼šåŒè‰²çƒåˆ†æ..."
          if [ -f "lottery_analyzer.py" ]; then
            python lottery_analyzer.py || true
          elif [ -f "scripts/lottery_analyzer.py" ]; then
            python scripts/lottery_analyzer.py || true
          elif [ -f "main.py" ]; then
            python main.py || true
          else
            echo "æœªæ‰¾åˆ°åŒè‰²çƒåˆ†æå…¥å£ (lottery_analyzer.py / scripts/lottery_analyzer.py / main.py)"
          fi
          echo "åŒè‰²çƒåˆ†æå®Œæˆ"

      - name: å‡†å¤‡ å¿«ä¹8 èµ”ç‡æ–‡ä»¶ï¼ˆè‹¥ç¼ºå¤±åˆ™å†™å…¥ç¤ºä¾‹-ä»»é€‰7ï¼‰
        run: |
          mkdir -p data
          if [ ! -f data/payouts_kl8.json ]; then
            cat > data/payouts_kl8.json << 'JSON'
            {
              "choose": 7,
              "price_per_bet": 2.0,
              "payouts": {
                "0": 2,
                "1": 0,
                "2": 0,
                "3": 0,
                "4": 10,
                "5": 28,
                "6": 288,
                "7": 10000
              }
            }
            JSON
          fi

      - name: è¿è¡Œ å¿«ä¹8ï¼ˆKL8ï¼‰æŠ“å–ä¸åˆ†æ
        run: |
          echo "å¼€å§‹è¿è¡Œï¼šå¿«ä¹8åˆ†æï¼ˆä»…æœ€è¿‘30æœŸ + ä»»é€‰7ï¼Œç”Ÿæˆå›¾è¡¨ä¸æŠ¥å‘Šï¼‰..."
          if [ -f "scripts/super_eight.py" ]; then
            # æŠ“å–æœ€è¿‘ 30 æœŸ
            python scripts/super_eight.py --fetch --limit 30 || true
            # ç”Ÿæˆå›¾è¡¨ + æŠ¥å‘Š + èµ„é‡‘æ–¹æ¡ˆï¼ˆå¿½ç•¥ Kellyï¼Œç”¨å…¨éƒ¨é¢„ç®—ï¼Œç¤ºä¾‹é¢„ç®—22å…ƒï¼‰
            python scripts/super_eight.py \
              --recommend 5 \
              --play_pick 7 \
              --payouts data/payouts_kl8.json \
              --plan --budget 22 --price_per_bet 2 \
              --plots --plots_dual --split 40 \
              --beta 8 --max_share 0.6 --min_stake 1 \
              --kelly_mode ignore \
              --report --seed 42 || true
          else
            echo "æœªæ‰¾åˆ° KL8 åˆ†æè„šæœ¬ scripts/super_eight.py"
          fi
          echo "å¿«ä¹8åˆ†æå®Œæˆ"

      - name: æ£€æŸ¥æ–‡ä»¶å˜æ›´
        id: git-check
        run: |
          echo "æ£€æŸ¥æ–‡ä»¶å˜æ›´..."
          # åˆ—å‡ºéœ€è¦ç›‘æ§çš„è·¯å¾„/æ–‡ä»¶ï¼ˆåŒè‰²çƒ + KL8ï¼‰
          MONITOR_PATHS=(
            data/ reports/ pics/ plots/
            kl8_analysis_report.md kl8_profit_plan.md
          )
          # è¿‡æ»¤å‡ºå­˜åœ¨çš„ç›®æ ‡ç”¨äº diff
          EXISTING_PATHS=()
          for p in "${MONITOR_PATHS[@]}"; do
            if [ -e "$p" ]; then
              EXISTING_PATHS+=("$p")
            fi
          done
          if [ ${#EXISTING_PATHS[@]} -eq 0 ]; then
            echo "changed=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          if git diff --exit-code "${EXISTING_PATHS[@]}" > /dev/null 2>&1; then
            echo "æ²¡æœ‰æ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´"
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "æ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´"
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "å˜æ›´çš„æ–‡ä»¶:"
            git diff --name-only "${EXISTING_PATHS[@]}" || true
          fi

      - name: æäº¤æ›´æ–°
        if: steps.git-check.outputs.changed == 'true'
        run: |
          echo "å‡†å¤‡æäº¤æ–‡ä»¶å˜æ›´..."
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          # ä»…æ·»åŠ å­˜åœ¨çš„è·¯å¾„
          [ -d "data" ] && git add data/ || true
          [ -d "reports" ] && git add reports/ || true
          [ -d "pics" ] && git add pics/ || true
          [ -d "plots" ] && git add plots/ || true
          [ -f "kl8_analysis_report.md" ] && git add kl8_analysis_report.md || true
          [ -f "kl8_profit_plan.md" ] && git add kl8_profit_plan.md || true

          if git diff --cached --quiet; then
            echo "æ²¡æœ‰æ–‡ä»¶éœ€è¦æäº¤"
            exit 0
          fi

          commit_message="ğŸ¯ æ›´æ–°åŒè‰²çƒä¸å¿«ä¹8æ•°æ®ä¸æŠ¥å‘Š - $(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S') (UTC+8)"
          git commit -m "$commit_message"
          git push
          echo "æ–‡ä»¶æäº¤æˆåŠŸ"

      - name: åˆ›å»ºå½“æ—¥å‘å¸ƒç‰ˆæœ¬ï¼ˆè‹¥æœ‰å˜æ›´ï¼‰
        if: steps.git-check.outputs.changed == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "å‡†å¤‡åˆ›å»ºå‘å¸ƒç‰ˆæœ¬..."
          TAG_NAME="$(TZ='Asia/Shanghai' date +'%Y%m%d')"
          if ! git tag | grep -q "^$TAG_NAME$"; then
            git tag $TAG_NAME
            git push origin $TAG_NAME

            cat > release_notes.md << 'EOF'
            ## ğŸ¯ æ•°æ®æ›´æ–° - $(TZ='Asia/Shanghai' date +'%Yå¹´%mæœˆ%dæ—¥') (UTC+8)

            ### ğŸ“Š æœ¬æ¬¡æ›´æ–°å†…å®¹
            - æŠ“å–æœ€æ–° **åŒè‰²çƒ** ä¸ **å¿«ä¹8** å¼€å¥–æ•°æ®
            - æ›´æ–°é¢‘ç‡/è¶‹åŠ¿å›¾è¡¨ä¸åˆ†ææŠ¥å‘Š

            ### ğŸ“ ä¸»è¦æ–‡ä»¶
            - `data/lottery_data.json`ï¼ˆåŒè‰²çƒï¼‰
            - `data/kl8_history.json`ï¼ˆå¿«ä¹8ï¼‰
            - `reports/analysis_report.md`ï¼ˆåŒè‰²çƒï¼‰
            - `kl8_analysis_report.md` / `kl8_profit_plan.md`ï¼ˆå¿«ä¹8ï¼‰
            - `pics/lottery_frequency_analysis.png`ï¼ˆåŒè‰²çƒå›¾è¡¨ï¼‰
            - `plots/kl8_*`ï¼ˆå¿«ä¹8å›¾è¡¨ï¼‰

            ### âš ï¸ å…è´£å£°æ˜
            æœ¬æ•°æ®ä»…ä¾›å­¦ä¹ å’Œç»Ÿè®¡åˆ†æä½¿ç”¨ï¼Œå½©ç¥¨å¼€å¥–å®Œå…¨éšæœºï¼Œè¯·ç†æ€§è´­å½©ã€‚
            EOF

            # é€‰æ‹©å­˜åœ¨çš„å·¥ä»¶ä¸Šä¼ 
            upload_files=""
            [ -f "data/lottery_data.json" ] && upload_files="$upload_files data/lottery_data.json"
            [ -f "data/kl8_history.json" ] && upload_files="$upload_files data/kl8_history.json"
            [ -f "reports/analysis_report.md" ] && upload_files="$upload_files reports/analysis_report.md"
            [ -f "kl8_analysis_report.md" ] && upload_files="$upload_files kl8_analysis_report.md"
            [ -f "kl8_profit_plan.md" ] && upload_files="$upload_files kl8_profit_plan.md"
            [ -f "pics/lottery_frequency_analysis.png" ] && upload_files="$upload_files pics/lottery_frequency_analysis.png"

            if [ -n "$upload_files" ]; then
              gh release create $TAG_NAME \
                --title "æ•°æ®æ›´æ–° $TAG_NAME" \
                --notes-file release_notes.md \
                $upload_files
              echo "å‘å¸ƒç‰ˆæœ¬åˆ›å»ºæˆåŠŸï¼ŒåŒ…å«æ–‡ä»¶: $upload_files"
            else
              gh release create $TAG_NAME \
                --title "æ•°æ®æ›´æ–° $TAG_NAME" \
                --notes-file release_notes.md
              echo "å‘å¸ƒç‰ˆæœ¬åˆ›å»ºæˆåŠŸï¼Œä½†æ²¡æœ‰æ•°æ®æ–‡ä»¶å¯ä¸Šä¼ "
            fi
          else
            echo "Tag $TAG_NAME å·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»ºå‘å¸ƒç‰ˆæœ¬"
          fi

      - name: è¾“å‡ºç»“æœ
        run: |
          if [ "${{ steps.git-check.outputs.changed }}" == "true" ]; then
            echo "âœ… æ•°æ®å·²æ›´æ–°å¹¶æäº¤ - $(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S') (UTC+8)"
          else
            echo "â„¹ï¸ æ•°æ®æ— å˜åŒ–ï¼Œè·³è¿‡æäº¤ - $(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S') (UTC+8)"
          fi