name: æ›´æ–°å½©ç¥¨æ•°æ®å’Œåˆ†ææŠ¥å‘Š

on:
  schedule:
    # æ¯å¤©æ™šä¸Š23:00 (UTC+8) è¿è¡Œï¼Œå¯¹åº” 15:00 UTC
    - cron: '0 15 * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘
  push:
    branches: [ main ]  # æ¨é€åˆ°mainåˆ†æ”¯æ—¶è§¦å‘
  pull_request:
    branches: [ main ]  # PRåˆå¹¶åˆ°mainåˆ†æ”¯æ—¶è§¦å‘
    types: [ closed ]   # åªåœ¨PRå…³é—­æ—¶è§¦å‘

permissions:
  contents: write

jobs:
  update-lottery-data:
    runs-on: ubuntu-latest
    env:
      HEARTBEAT: "true"   # è‹¥å¸Œæœ›ä»…åœ¨çœŸå®æ•°æ®å˜åŒ–æ—¶æäº¤ï¼Œå°†å…¶æ”¹ä¸º "false"
    # ç¡®ä¿PRåªåœ¨åˆå¹¶æ—¶è¿è¡Œï¼Œè€Œä¸æ˜¯ç®€å•å…³é—­æ—¶è¿è¡Œ
    if: github.event_name != 'pull_request' || github.event.pull_request.merged == true

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: ç¼“å­˜pipä¾èµ–
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install requests pandas numpy matplotlib seaborn beautifulsoup4 hjson DrissionPage
        pip install scipy statsmodels

        # å®‰è£… CPU ç‰ˆ PyTorchï¼ˆé¿å… CUDA ä¾èµ–ï¼‰
        pip install torch --index-url https://download.pytorch.org/whl/cpu || true

        # DrissionPage å¦‚éœ€æµè§ˆå™¨ï¼Œè¯·åœ¨éœ€è¦æ—¶å¼€å¯ä»¥ä¸‹è„šæœ¬ï¼ˆé»˜è®¤å…³é—­ä»¥åŠ å¿«æ‰§è¡Œé€Ÿåº¦ï¼‰
        # echo "å®‰è£…Chromeæµè§ˆå™¨..."
        # wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
        # echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" | sudo tee /etc/apt/sources.list.d/google-chrome.list
        # sudo apt-get update
        # sudo apt-get install -y google-chrome-stable
        # google-chrome --version
        # export DISPLAY=:99

    - name: è¿è¡Œæ•°æ®æŠ“å–ä¸åˆ†æ (åŒè‰²çƒ + å¿«ä¹8)
      run: |
        echo "å¼€å§‹è¿è¡Œæ•°æ®åˆ†æ..."
        exit_code=0

        if [ -f "lottery_analyzer.py" ]; then
          echo "[SSQ] è¿è¡Œ lottery_analyzer.py ..."
          python lottery_analyzer.py || exit_code=$?
        else
          echo "[SSQ] æœªæ‰¾åˆ° lottery_analyzer.pyï¼Œè·³è¿‡"
        fi

        if [ -f "scripts/super_eight.py" ]; then
          echo "[KL8] è¿è¡Œ scripts/super_eight.py ..."
          python scripts/super_eight.py --fetch --limit 200 --recommend 5 --plots --plots_dual --report --seed 42 || exit_code=$?
        elif [ -f "super_eight.py" ]; then
          echo "[KL8] è¿è¡Œ super_eight.py ..."
          python super_eight.py --fetch --limit 200 --recommend 5 --plots --plots_dual --report --seed 42 || exit_code=$?
        else
          echo "[KL8] æœªæ‰¾åˆ° super_eight.pyï¼Œè·³è¿‡"
        fi

        echo "åˆ†æå®Œæˆï¼Œé€€å‡ºç : $exit_code"

        if [ "$HEARTBEAT" = "true" ]; then
          mkdir -p .github
          date -u +"%Y-%m-%dT%H:%M:%SZ" > .github/.last_run_utc.txt
          echo "å·²å†™å…¥å¿ƒè·³æ–‡ä»¶ .github/.last_run_utc.txt"
        fi

        echo "ç»§ç»­åˆ°æ–‡ä»¶å˜æ›´æ£€æŸ¥æ­¥éª¤..."

    - name: æ£€æŸ¥æ–‡ä»¶å˜æ›´
      id: git-check
      run: |
        echo "æ£€æŸ¥æ–‡ä»¶å˜æ›´..."
        # ä»…åœ¨è¿™äº›ç›®å½•/æ–‡ä»¶å­˜åœ¨æ—¶å†æ¯”è¾ƒ
        TARGETS=()
        for p in data reports pics; do
          [ -e "$p" ] && TARGETS+=("$p")
        done
        [ -f ".github/.last_run_utc.txt" ] && TARGETS+=(".github/.last_run_utc.txt")
        [ -f "data/kl8_history.json" ] && TARGETS+=("data/kl8_history.json")
        [ -f "reports/kl8_analysis_report.md" ] && TARGETS+=("reports/kl8_analysis_report.md")
        [ -f "reports/kl8_profit_plan.md" ] && TARGETS+=("reports/kl8_profit_plan.md")
        [ -f "pics/kl8_frequency_hist.png" ] && TARGETS+=("pics/kl8_frequency_hist.png")
        [ -f "pics/kl8_ema_heatmap.png" ] && TARGETS+=("pics/kl8_ema_heatmap.png")
        [ -f "pics/kl8_overlap_compare.png" ] && TARGETS+=("pics/kl8_overlap_compare.png")
        [ -f "pics/kl8_dual_frequency_style.png" ] && TARGETS+=("pics/kl8_dual_frequency_style.png")
        if [ ${#TARGETS[@]} -eq 0 ]; then
          echo "æœªæ‰¾åˆ° data/ reports/ pics/ ç›®å½•æˆ–æ–‡ä»¶ï¼Œè§†ä¸ºæ— å˜åŒ–"
          echo "changed=false" >> $GITHUB_OUTPUT
          exit 0
        fi

        CHANGED=false

        # 1) æ£€æµ‹æœªè·Ÿè¸ª(æ–°)æ–‡ä»¶
        UNTRACKED=$(git ls-files --others --exclude-standard -- "${TARGETS[@]}")
        if [ -n "$UNTRACKED" ]; then
          echo "å‘ç°æœªè·Ÿè¸ªæ–‡ä»¶:"
          echo "$UNTRACKED"
          CHANGED=true
        fi

        # 2) æ£€æµ‹å·²è·Ÿè¸ªæ–‡ä»¶çš„ä¿®æ”¹/åˆ é™¤
        if ! git diff --exit-code -- "${TARGETS[@]}" >/dev/null 2>&1; then
          echo "å‘ç°å·²è·Ÿè¸ªæ–‡ä»¶ä¿®æ”¹/åˆ é™¤"
          CHANGED=true
        fi

        if [ "$CHANGED" = true ]; then
          echo "changed=true" >> $GITHUB_OUTPUT
        else
          echo "æ²¡æœ‰æ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´"
          echo "changed=false" >> $GITHUB_OUTPUT
        fi

    - name: æäº¤æ›´æ–°
      if: steps.git-check.outputs.changed == 'true'
      run: |
        echo "å‡†å¤‡æäº¤æ–‡ä»¶å˜æ›´..."
        git config --local user.email "snjyor@gmail.com"
        git config --local user.name "snjyor"

        [ -e "data" ] && git add -A data || echo "data ç›®å½•ä¸å­˜åœ¨"
        [ -e "reports" ] && git add -A reports || echo "reports ç›®å½•ä¸å­˜åœ¨"
        [ -e "pics" ] && git add -A pics || echo "pics ç›®å½•ä¸å­˜åœ¨"
        [ -f ".github/.last_run_utc.txt" ] && git add .github/.last_run_utc.txt

        if git diff --cached --quiet; then
          echo "æ²¡æœ‰æ–‡ä»¶éœ€è¦æäº¤"
          exit 0
        fi

        commit_message="Update lottery data and analysis reports - $(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S') (UTC+8)"
        git commit -m "$commit_message"
        git push
        echo "æ–‡ä»¶æäº¤æˆåŠŸ"

    - name: åˆ›å»ºé‡å¤§æ›´æ–°çš„å‘å¸ƒç‰ˆæœ¬
      if: steps.git-check.outputs.changed == 'true'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "å‡†å¤‡åˆ›å»ºå‘å¸ƒç‰ˆæœ¬..."
        TAG_NAME="$(TZ='Asia/Shanghai' date +'%Y%m%d')"
        if ! git tag | grep -q "^$TAG_NAME$"; then
          git tag $TAG_NAME
          git push origin $TAG_NAME

          NOTES=$'## ğŸ¯ å½©ç¥¨æ•°æ®æ›´æ–° - '"$(TZ='Asia/Shanghai' date +'%Yå¹´%mæœˆ%dæ—¥')"$' (UTC+8)\n\n'
          NOTES+=$'### ğŸ“Š æœ¬æ¬¡æ›´æ–°å†…å®¹\n'
          NOTES+=$'- æŠ“å–æœ€æ–°å¼€å¥–æ•°æ®ï¼ˆåŒè‰²çƒ/å¿«ä¹8ï¼‰\n'
          NOTES+=$'- æ›´æ–°ç»Ÿè®¡åˆ†æå›¾è¡¨\n'
          NOTES+=$'- åˆ·æ–°å·ç é¢‘ç‡ä¸æŠ¥å‘Š\n\n'
          NOTES+=$'### ğŸ“ æ›´æ–°æ–‡ä»¶\n'
          NOTES+=$'**åŒè‰²çƒæ•°æ®ï¼š**\n'
          NOTES+=$'- data/lottery_data.json - åŒè‰²çƒå¼€å¥–æ•°æ®\n'
          NOTES+=$'- data/lottery_aggregated_data.hjson - åŒè‰²çƒèšåˆåˆ†ææ•°æ®\n'
          NOTES+=$'- reports/double_color_ball_analysis_report.md - åŒè‰²çƒåˆ†ææŠ¥å‘Š\n'
          NOTES+=$'- pics/lottery_frequency_analysis.png - åŒè‰²çƒé¢‘ç‡å›¾è¡¨\n\n'
          NOTES+=$'**å¿«ä¹8æ•°æ®ï¼š**\n'
          NOTES+=$'- data/kl8_history.json - å¿«ä¹8å¼€å¥–æ•°æ®\n'
          NOTES+=$'- reports/kl8_analysis_report.md - å¿«ä¹8åˆ†ææŠ¥å‘Š\n'
          NOTES+=$'- pics/kl8_frequency_hist.png, pics/kl8_ema_heatmap.png, pics/kl8_overlap_compare.png, pics/kl8_dual_frequency_style.png\n\n'
          NOTES+=$'### âš ï¸ å…è´£å£°æ˜\n'
          NOTES+=$'æœ¬æ•°æ®ä»…ä¾›å­¦ä¹ å’Œç»Ÿè®¡åˆ†æä½¿ç”¨ï¼Œå½©ç¥¨å¼€å¥–å®Œå…¨éšæœºï¼Œè¯·ç†æ€§è´­å½©ã€‚\n'

          upload_files=""
          [ -f "data/lottery_data.json" ] && upload_files="$upload_files data/lottery_data.json"
          [ -f "data/lottery_aggregated_data.hjson" ] && upload_files="$upload_files data/lottery_aggregated_data.hjson"
          [ -f "reports/analysis_report.md" ] && upload_files="$upload_files reports/analysis_report.md"
          [ -f "pics/lottery_frequency_analysis.png" ] && upload_files="$upload_files pics/lottery_frequency_analysis.png"

          # KL8 artifacts
          [ -f "data/kl8_history.json" ] && upload_files="$upload_files data/kl8_history.json"
          [ -f "reports/kl8_analysis_report.md" ] && upload_files="$upload_files reports/kl8_analysis_report.md"
          [ -f "pics/kl8_frequency_hist.png" ] && upload_files="$upload_files pics/kl8_frequency_hist.png"
          [ -f "pics/kl8_ema_heatmap.png" ] && upload_files="$upload_files pics/kl8_ema_heatmap.png"
          [ -f "pics/kl8_overlap_compare.png" ] && upload_files="$upload_files pics/kl8_overlap_compare.png"
          [ -f "pics/kl8_dual_frequency_style.png" ] && upload_files="$upload_files pics/kl8_dual_frequency_style.png"

          if command -v gh >/dev/null 2>&1; then
            if [ -n "$upload_files" ]; then
              gh release create $TAG_NAME \
                --title "å½©ç¥¨æ•°æ®æ›´æ–° $TAG_NAME" \
                --notes "$NOTES" \
                $upload_files
              echo "å‘å¸ƒç‰ˆæœ¬åˆ›å»ºæˆåŠŸï¼ŒåŒ…å«æ–‡ä»¶: $upload_files"
            else
              gh release create $TAG_NAME \
                --title "å½©ç¥¨æ•°æ®æ›´æ–° $TAG_NAME" \
                --notes "$NOTES"
              echo "å‘å¸ƒç‰ˆæœ¬åˆ›å»ºæˆåŠŸï¼Œä½†æ²¡æœ‰æ•°æ®æ–‡ä»¶å¯ä¸Šä¼ "
            fi
          else
            echo "âš ï¸ æœªå®‰è£… gh CLIï¼Œè·³è¿‡åˆ›å»ºå‘å¸ƒç‰ˆæœ¬ã€‚"
          fi
        else
          echo "Tag $TAG_NAME å·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»ºå‘å¸ƒç‰ˆæœ¬"
        fi

    - name: è¾“å‡ºç»“æœ
      run: |
        if [ "${{ steps.git-check.outputs.changed }}" == "true" ]; then
          echo "âœ… å½©ç¥¨æ•°æ®å·²æ›´æ–°å¹¶æäº¤ - $(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S') (UTC+8)"
          echo "ğŸ“ æ›´æ–°çš„æ–‡ä»¶:"
          [ -f "data/lottery_data.json" ] && echo "  âœ“ åŒè‰²çƒå¼€å¥–æ•°æ®"
          [ -f "reports/analysis_report.md" ] && echo "  âœ“ åŒè‰²çƒåˆ†ææŠ¥å‘Š"
          [ -f "pics/lottery_frequency_analysis.png" ] && echo "  âœ“ åŒè‰²çƒé¢‘ç‡å›¾è¡¨"
          [ -f ".github/.last_run_utc.txt" ] && echo "  âœ“ å¿ƒè·³æ–‡ä»¶ (.github/.last_run_utc.txt)"
        else
          echo "â„¹ï¸ å½©ç¥¨æ•°æ®æ— å˜åŒ–ï¼Œè·³è¿‡æäº¤ - $(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S') (UTC+8)"
        fi